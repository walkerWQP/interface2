//
//  HomeTViewController.m
//  ZhiNengXiaoFu
//
//  Created by duxiu on 2018/10/10.
//  Copyright © 2018年 henanduxiu. All rights reserved.
//

#import "HomeTViewController.h"
#import "NewPagedFlowView.h"
#import "PGIndexBannerSubiew.h"
#import "HomePageJingJiView.h"
#import "WorkCell.h"
#import "homeWorkCell.h"
#import "SchoolDongTaiCell.h"
#import "HomePageTongZhiView.h"

@interface HomeTViewController ()<NewPagedFlowViewDelegate, NewPagedFlowViewDataSource, UITableViewDelegate, UITableViewDataSource, HomePageJingJiViewDelegate>

@property (nonatomic, strong) NSString  * schoolName;
/**
 *  图片数组
 */
@property (nonatomic, strong) NSMutableArray *imageArray;

@property (nonatomic, strong) UITableView * HomePageJTabelView;

@property (nonatomic, strong) UIImageView * img;

@end

@implementation HomeTViewController

- (void)viewDidLoad
{
    
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    
    UIImage *image1 = [UIImage imageNamed:@"banner"];
    UIImage *image2 = [UIImage imageNamed:@"bannerHelper"];
    UIImage *image3 = [UIImage imageNamed:@"教师端活动管理banner"];
    UIImage *image4 = [UIImage imageNamed:@"banner"];
    UIImage *image5 = [UIImage imageNamed:@"请假列表背景图"];
    self.imageArray = [NSMutableArray arrayWithObjects:image1,image2,image3, image4,image5,nil];
    
    self.view.backgroundColor = [UIColor whiteColor];
    [self setUser];
    
    [self.view addSubview:self.HomePageJTabelView];
    
    self.HomePageJTabelView.separatorStyle = UITableViewCellSeparatorStyleNone;
    [self.HomePageJTabelView registerClass:[homeWorkCell class] forCellReuseIdentifier:@"homeWorkCellId"];
    
    [self.HomePageJTabelView registerNib:[UINib nibWithNibName:@"SchoolDongTaiCell" bundle:nil] forCellReuseIdentifier:@"SchoolDongTaiCellId"];
    
    
    //   [[UITabBar appearance] setTintColor:[UIColor blackColor]];
    
}

- (UITableView *)HomePageJTabelView
{
    if (!_HomePageJTabelView) {
        self.HomePageJTabelView = [[UITableView alloc] initWithFrame:CGRectMake(0, 0, kScreenWidth, kScreenHeight - APP_NAVH) style:UITableViewStylePlain];
        self.HomePageJTabelView.delegate = self;
        self.HomePageJTabelView.dataSource = self;
    }
    return _HomePageJTabelView;
}

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
{
    if (section == 3) {
        return 3;
    }else if (section == 5){
        return 2;
    } else {
        return 1;
        
    }
}

- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView
{
    return 6;
}

- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath
{
    if (indexPath.section == 0) {
        return 200;
    }else if (indexPath.section == 1)
    {
        return 100;
    }else if (indexPath.section == 2)
    {
        return 75;
    }else if (indexPath.section == 3)
    {
        return 71;
    }else if (indexPath.section == 4)
    {
        return 80;
    }else
    {
        return 104;
    }
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath
{
    
    if (indexPath.section == 0) {
        static NSString *CellIdentifier = @"TableViewCell";
        UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:CellIdentifier];
        if (cell == nil) {
            cell = [[UITableViewCell alloc] initWithStyle:UITableViewCellStyleValue1 reuseIdentifier:CellIdentifier];
        } else {
            //删除cell中的子对象,刷新覆盖问题。
            while ([cell.contentView.subviews lastObject] != nil) {
                [(UIView*)[cell.contentView.subviews lastObject] removeFromSuperview];
            }
        }
        
        self.automaticallyAdjustsScrollViewInsets = NO;
        
        NewPagedFlowView *pageFlowView = [[NewPagedFlowView alloc] initWithFrame:CGRectMake(0, 0, kScreenWidth, 200)];
        pageFlowView.delegate = self;
        pageFlowView.dataSource = self;
        pageFlowView.minimumPageAlpha = 0.1;
        pageFlowView.isCarousel = YES;
        pageFlowView.orientation = NewPagedFlowViewOrientationHorizontal;
        pageFlowView.isOpenAutoScroll = YES;
        
        //初始化pageControl
        //    UIPageControl *pageControl = [[UIPageControl alloc] initWithFrame:CGRectMake(0, pageFlowView.frame.size.height - 32, Width, 8)];
        //    pageFlowView.pageControl = pageControl;
        //    [pageFlowView addSubview:pageControl];
        [pageFlowView reloadData];
        
        [cell addSubview:pageFlowView];
        
        cell.selectionStyle = UITableViewCellSelectionStyleNone;
        return cell;
    }else  if (indexPath.section == 1)
    {
        static NSString *CellIdentifier = @"TableViewCell";
        UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:CellIdentifier];
        if (cell == nil) {
            cell = [[UITableViewCell alloc] initWithStyle:UITableViewCellStyleValue1 reuseIdentifier:CellIdentifier];
        } else {
            //删除cell中的子对象,刷新覆盖问题。
            while ([cell.contentView.subviews lastObject] != nil) {
                [(UIView*)[cell.contentView.subviews lastObject] removeFromSuperview];
            }
        }
        
        NSMutableArray * imgAry = [NSMutableArray arrayWithObjects:@"请假列表",@"问题咨询1",@"班级圈子",@"老师通知",@"新生指南1", nil];
        NSMutableArray * titleAry = [NSMutableArray arrayWithObjects:@"请假列表",@"问题咨询",@"班级圈子",@"老师通知",@"新生指南", nil];
        NSInteger width = (kScreenWidth - 50 - 45 * 5) / 4;
        for (int i = 0; i < 5; i++) {
            
            UIButton * back = [[UIButton alloc] initWithFrame:CGRectMake(25 + i * (40 + width), 10, 40, 40)];
            [back setBackgroundImage:[UIImage imageNamed:[imgAry objectAtIndex:i]] forState:UIControlStateNormal];
            [back addTarget:self action:@selector(backBtn:) forControlEvents:UIControlEventTouchDown];
            back.tag = i;
            //            back.image = [UIImage imageNamed:[imgAry objectAtIndex:i]];
            [cell addSubview:back];
            
            UILabel * titleLabel = [[UILabel alloc] initWithFrame:CGRectMake(back.frame.origin.x - 5, back.frame.origin.y + back.frame.size.height + 5, 55, 15)];
            titleLabel.text = [titleAry objectAtIndex:i];
            titleLabel.font = [UIFont systemFontOfSize:12];
            titleLabel.textAlignment = NSTextAlignmentCenter;
            titleLabel.textColor = RGB(51, 51, 51);
            [cell addSubview:titleLabel];
        }
        
        UIView * lineView = [[UIView alloc] initWithFrame:CGRectMake(0, 88, kScreenWidth, 10)];
        lineView.backgroundColor = [UIColor colorWithRed:250 / 255.0 green:250 / 255.0 blue:250 / 255.0 alpha:1];
        [cell addSubview:lineView];
        
        cell.selectionStyle = UITableViewCellSelectionStyleNone;
        return cell;
    }else if (indexPath.section == 2)
    {
        static NSString *CellIdentifier = @"TableViewCell";
        UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:CellIdentifier];
        if (cell == nil) {
            cell = [[UITableViewCell alloc] initWithStyle:UITableViewCellStyleValue1 reuseIdentifier:CellIdentifier];
        } else {
            //删除cell中的子对象,刷新覆盖问题。
            while ([cell.contentView.subviews lastObject] != nil) {
                [(UIView*)[cell.contentView.subviews lastObject] removeFromSuperview];
            }
        }
        
        UIImageView * tongZhiImg = [[UIImageView alloc] initWithFrame:CGRectMake(15, 10, 46, 39)];
        tongZhiImg.image = [UIImage imageNamed:@"通知New"];
        [cell addSubview:tongZhiImg];
        
        HomePageTongZhiView *ccspView=[[HomePageTongZhiView alloc] initWithFrame:CGRectMake(46 + 15 + 10, 0, kScreenWidth, 60)];
        ccspView.titleArray = [NSMutableArray arrayWithObjects:@"1",@"2", @"3", nil];
        [cell addSubview:ccspView];
        
        UIView * lineView = [[UIView alloc] initWithFrame:CGRectMake(0, 60, kScreenWidth, 10)];
        lineView.backgroundColor = [UIColor colorWithRed:250 / 255.0 green:250 / 255.0 blue:250 / 255.0 alpha:1];
        [cell addSubview:lineView];
        
        return cell;
        
    }else if (indexPath.section == 3)
    {
        
        homeWorkCell * cell = [tableView dequeueReusableCellWithIdentifier:@"homeWorkCellId" forIndexPath:indexPath];
        if (indexPath.row == 2) {
            cell.lineView.hidden = YES;
        }
        return cell;
        
    }else if (indexPath.section == 4)
    {
        static NSString *CellIdentifier = @"TableViewCell";
        UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:CellIdentifier];
        if (cell == nil) {
            cell = [[UITableViewCell alloc] initWithStyle:UITableViewCellStyleValue1 reuseIdentifier:CellIdentifier];
        }else{
            //删除cell中的子对象,刷新覆盖问题。
            while ([cell.contentView.subviews lastObject] != nil) {
                [(UIView*)[cell.contentView.subviews lastObject] removeFromSuperview];
            }
        }
        
        cell.selectionStyle = UITableViewCellSelectionStyleNone;
        cell.backgroundColor=[UIColor colorWithRed:32/ 255.0 green:32 / 255.0 blue:32 / 255.0 alpha:1.0f];
        NSMutableArray * ary = [NSMutableArray arrayWithObjects:@"开学典礼",@"参观活动",@"运动会", nil];
        NSArray *array=[NSArray arrayWithArray:ary];
        HomePageJingJiView *view=[[HomePageJingJiView alloc] init];
        view.frame=CGRectMake(0,0, kScreenWidth,  (kScreenWidth - 30) / 2.9 * 144 / 235 + 25);
        view.HomePageJingJiViewDelegate = self;
        [view setDetail:array];
        [cell.contentView addSubview:view];
        return cell;
        
        
    }else
    {
        
        SchoolDongTaiCell * cell = [tableView dequeueReusableCellWithIdentifier:@"SchoolDongTaiCellId" forIndexPath:indexPath];
        return cell;
    }
}

- (UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section
{
    if (section == 3 || section == 4 || section == 5) {
        UIView * header = [[UIView alloc] initWithFrame:CGRectMake(0, 0, kScreenWidth, 40)];
        
        if (section == 3)
        {
            self.img = [[UIImageView alloc] initWithFrame:CGRectMake(15, 14, 15, 12)];
            self.img.image = [UIImage imageNamed:@"查看作业"];
        }else if (section == 4)
        {
            self.img = [[UIImageView alloc] initWithFrame:CGRectMake(15, 12.5, 15, 15)];
            self.img.image = [UIImage imageNamed:@"竞技活动头"];
        }else
        {
            self.img = [[UIImageView alloc] initWithFrame:CGRectMake(15, 12, 14, 16)];
            self.img.image = [UIImage imageNamed:@"学校动态头"];
        }
        
        [header addSubview:self.img];
        
        UILabel * titleLabel = [[UILabel alloc] initWithFrame:CGRectMake(self.img.frame.origin.x + self.img.frame.size.width + 5, 10, 200, 20)];
        if (section == 3)
        {
            titleLabel.text = @"作业管理";
        }else if (section == 4)
        {
            titleLabel.text = @"活动管理";
        }else
        {
            titleLabel.text = @"学校动态";
        }
        
        titleLabel.font = [UIFont systemFontOfSize:15];
        titleLabel.textColor = RGB(119, 119, 119);
        [header addSubview:titleLabel];
        
        UILabel * moreLabel = [[UILabel alloc] initWithFrame:CGRectMake(kScreenWidth - 50, 14, 25, 12)];
        moreLabel.text = @"更多";
        moreLabel.textColor = RGB(170, 170, 170);
        moreLabel.font = [UIFont systemFontOfSize:12];
        [header addSubview:moreLabel];
        
        UIImageView * moreImg = [[UIImageView alloc] initWithFrame:CGRectMake(moreLabel.frame.origin.x + moreLabel.frame.size.width + 4, 14, 12, 12)];
        moreImg.image = [UIImage imageNamed:@"返回"];
        [header addSubview:moreImg];
        
        
        return header;
    }else
    {
        return nil;
    }
    
}


- (CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section
{
    if (section == 3 || section == 4 || section == 5) {
        return 40;
    }else
    {
        return 0;
    }
}

- (void)backBtn:(UIButton *)sender
{
    
}

#pragma mark NewPagedFlowView Delegate
- (CGSize)sizeForPageInFlowView:(NewPagedFlowView *)flowView {
    return CGSizeMake(kScreenWidth - 60, (kScreenWidth - 60) * 9 / 16);
}

- (void)didSelectCell:(UIView *)subView withSubViewIndex:(NSInteger)subIndex {
    
    NSLog(@"点击了第%ld张图",(long)subIndex + 1);
}

- (void)didScrollToPage:(NSInteger)pageNumber inFlowView:(NewPagedFlowView *)flowView {
    
    NSLog(@"ViewController 滚动到了第%ld页",pageNumber);
}

#pragma mark NewPagedFlowView Datasource
- (NSInteger)numberOfPagesInFlowView:(NewPagedFlowView *)flowView {
    
    return self.imageArray.count;
    
}

- (PGIndexBannerSubiew *)flowView:(NewPagedFlowView *)flowView cellForPageAtIndex:(NSInteger)index{
    PGIndexBannerSubiew *bannerView = [flowView dequeueReusableCell];
    if (!bannerView) {
        bannerView = [[PGIndexBannerSubiew alloc] init];
        bannerView.tag = index;
        bannerView.layer.cornerRadius = 4;
        bannerView.layer.masksToBounds = YES;
    }
    //在这里下载网络图片
    //  [bannerView.mainImageView sd_setImageWithURL:[NSURL URLWithString:[NSString stringWithFormat:hostUrlsImg,imageDict[@"img"]]] placeholderImage:[UIImage imageNamed:@""]];
    bannerView.mainImageView.image = self.imageArray[index];
    
    return bannerView;
}


#pragma mark --懒加载
//- (NSMutableArray *)imageArray
//{
//    if (_imageArray == nil)
//    {
//        _imageArray = [NSMutableArray array];
//    }
//    return _imageArray;
//}


#pragma mark ======= 获取个人信息数据 =======
- (void)setUser
{
    NSDictionary * dic = @{@"key":[UserManager key]};
    [[HttpRequestManager sharedSingleton] POST:getUserInfoURL parameters:dic success:^(NSURLSessionDataTask *task, id responseObject) {
        NSLog(@"%@", responseObject);
        if ([[responseObject objectForKey:@"status"] integerValue] == 200) {
            
            self.schoolName = [[responseObject objectForKey:@"data"] objectForKey:@"school_name"];
            UILabel  *titleLabel = [[UILabel alloc] initWithFrame:CGRectMake(0,0, 200, 44)];
            titleLabel.backgroundColor = [UIColor clearColor];
            titleLabel.font = [UIFont boldSystemFontOfSize:18];
            titleLabel.textColor = [UIColor blackColor];
            titleLabel.textAlignment = NSTextAlignmentCenter;
            titleLabel.text = self.schoolName;
            self.navigationItem.titleView = titleLabel;
            
        } else {
            if ([[responseObject objectForKey:@"status"] integerValue] == 401 || [[responseObject objectForKey:@"status"] integerValue] == 402) {
                [UserManager logoOut];
            } else {
                
            }
            [WProgressHUD showErrorAnimatedText:[responseObject objectForKey:@"msg"]];
            
        }
        
    } failure:^(NSURLSessionDataTask *task, NSError *error) {
        NSLog(@"%@", error);
    }];
}




@end
